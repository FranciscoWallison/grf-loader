import{inflate as w}from"pako";import D from"jdataview";var l=new Uint8Array([128,64,32,16,8,4,2,1]),i=new Uint8Array(8),s=new Uint8Array(8),c=new Uint8Array(8),v=new Uint8Array([58,50,42,34,26,18,10,2,60,52,44,36,28,20,12,4,62,54,46,38,30,22,14,6,64,56,48,40,32,24,16,8,57,49,41,33,25,17,9,1,59,51,43,35,27,19,11,3,61,53,45,37,29,21,13,5,63,55,47,39,31,23,15,7]),S=new Uint8Array([40,8,48,16,56,24,64,32,39,7,47,15,55,23,63,31,38,6,46,14,54,22,62,30,37,5,45,13,53,21,61,29,36,4,44,12,52,20,60,28,35,3,43,11,51,19,59,27,34,2,42,10,50,18,58,26,33,1,41,9,49,17,57,25]),T=new Uint8Array([16,7,20,21,29,12,28,17,1,15,23,26,5,18,31,10,2,8,24,14,32,27,3,9,19,13,30,6,22,11,4,25]),h=[new Uint8Array([239,3,65,253,216,116,30,71,38,239,251,34,179,216,132,30,57,172,167,96,98,193,205,186,92,150,144,89,5,59,122,133,64,253,30,200,231,138,139,33,218,67,100,159,45,20,177,114,245,91,200,182,156,55,118,236,57,160,163,5,82,110,15,217]),new Uint8Array([167,221,13,120,158,11,227,149,96,54,54,79,249,96,90,163,17,36,210,135,200,82,117,236,187,193,76,186,36,254,143,25,218,19,102,175,73,208,144,6,140,106,251,145,55,141,13,120,191,73,17,244,35,229,206,59,85,188,162,87,232,34,116,206]),new Uint8Array([44,234,193,191,74,36,31,194,121,71,162,124,182,217,104,21,128,86,93,1,51,253,244,174,222,48,7,155,229,131,155,104,73,180,46,131,31,194,181,124,162,25,216,229,124,47,131,218,247,107,144,254,196,1,90,151,97,166,61,64,11,88,230,61]),new Uint8Array([77,209,178,15,40,189,228,120,246,74,15,147,139,23,209,164,58,236,201,53,147,86,126,203,85,32,160,254,108,137,23,98,23,98,75,177,180,222,209,135,201,20,60,74,126,168,226,125,160,159,246,92,106,9,141,240,15,227,83,37,149,54,40,203])];function F(t,e){for(let r=0;r<64;++r){let x=v[r]-1;t[e+(x>>3&7)]&l[x&7]&&(i[r>>3&7]|=l[r&7])}t.set(i,e),i.set(c)}function P(t,e){for(let r=0;r<64;++r){let x=S[r]-1;t[e+(x>>3&7)]&l[x&7]&&(i[r>>3&7]|=l[r&7])}t.set(i,e),i.set(c)}function R(t,e){for(let r=0;r<32;++r){let x=T[r]-1;t[e+(x>>3)]&l[x&7]&&(i[(r>>3)+4]|=l[r&7])}t.set(i,e),i.set(c)}function B(t,e){i[0]=(t[e+7]<<5|t[e+4]>>3)&63,i[1]=(t[e+4]<<1|t[e+5]>>7)&63,i[2]=(t[e+4]<<5|t[e+5]>>3)&63,i[3]=(t[e+5]<<1|t[e+6]>>7)&63,i[4]=(t[e+5]<<5|t[e+6]>>3)&63,i[5]=(t[e+6]<<1|t[e+7]>>7)&63,i[6]=(t[e+6]<<5|t[e+7]>>3)&63,i[7]=(t[e+7]<<1|t[e+4]>>7)&63,t.set(i,e),i.set(c)}function _(t,e){for(let r=0;r<4;++r)i[r]=h[r][t[r*2+0+e]]&240|h[r][t[r*2+1+e]]&15;t.set(i,e),i.set(c)}function I(t,e){for(let r=0;r<8;r++)s[r]=t[e+r];B(s,0),_(s,0),R(s,0),t[e+0]^=s[4],t[e+1]^=s[5],t[e+2]^=s[6],t[e+3]^=s[7]}function b(t,e){F(t,e),I(t,e),P(t,e)}function A(t,e,r){let x=r.toString().length,f=x<3?1:x<5?x+1:x<7?x+9:x+15,n=e>>3;for(let a=0;a<20&&a<n;++a)b(t,a*8);for(let a=20,o=-1;a<n;++a){if(a%f===0){b(t,a*8);continue}++o&&o%7===0&&L(t,a*8)}}function U(t,e){let r=e>>3;for(let x=0;x<20&&x<r;++x)b(t,x*8)}function L(t,e){i[0]=t[e+3],i[1]=t[e+4],i[2]=t[e+6],i[3]=t[e+0],i[4]=t[e+1],i[5]=t[e+2],i[6]=t[e+5],i[7]=z[t[e+7]],t.set(i,e),i.set(c)}var z=(()=>{let t=new Uint8Array([0,43,108,128,1,104,72,119,96,255,185,192,254,235]),e=new Uint8Array(Array.from({length:256},(x,f)=>f)),r=t.length;for(let x=0;x<r;x+=2)e[t[x+0]]=t[x+1],e[t[x+1]]=t[x+0];return e})();var N=1,j=2,C=4,G="Master of Magic",d=46,E=Uint32Array.BYTES_PER_ELEMENT*2,u=class{constructor(e){this.fd=e;this.version=512;this.fileCount=0;this.loaded=!1;this.files=new Map;this.fileTableOffset=0}async getStreamReader(e,r){let x=await this.getStreamBuffer(this.fd,e,r);return new D(x,void 0,void 0,!0)}async load(){this.loaded||(await this.parseHeader(),await this.parseFileList(),this.loaded=!0)}async parseHeader(){let e=await this.getStreamReader(0,d);if(e.getString(15)!==G)throw new Error("Not a GRF file (invalid signature)");e.skip(15),this.fileTableOffset=e.getUint32()+d;let x=e.getUint32();if(this.fileCount=e.getUint32()-x-7,this.version=e.getUint32(),this.version!==512)throw new Error(`Unsupported version "0x${this.version.toString(16)}"`)}async parseFileList(){let e=await this.getStreamReader(this.fileTableOffset,E),r=e.getUint32(),x=e.getUint32(),f=await this.getStreamBuffer(this.fd,this.fileTableOffset+E,r),n=w(f,{});for(let a=0,o=0;a<this.fileCount;++a){let y="";for(;n[o];)y+=String.fromCharCode(n[o++]);o++;let g={compressedSize:n[o++]|n[o++]<<8|n[o++]<<16|n[o++]<<24,lengthAligned:n[o++]|n[o++]<<8|n[o++]<<16|n[o++]<<24,realSize:n[o++]|n[o++]<<8|n[o++]<<16|n[o++]<<24,type:n[o++],offset:(n[o++]|n[o++]<<8|n[o++]<<16|n[o++]<<24)>>>0};g.type&N&&this.files.set(y,g)}}decodeEntry(e,r){return r.type&j?A(e,r.lengthAligned,r.compressedSize):r.type&C&&U(e,r.lengthAligned),r.realSize===r.compressedSize?e:w(e,{})}async getFile(e){if(!this.loaded)return Promise.resolve({data:null,error:"GRF not loaded yet"});let r=e;if(!this.files.has(r))return Promise.resolve({data:null,error:`File "${r}" not found`});let x=this.files.get(r);if(!x)return{data:null,error:`File "${r}" not found`};let f=await this.getStreamBuffer(this.fd,x.offset+d,x.lengthAligned);try{let n=this.decodeEntry(f,x);return Promise.resolve({data:n,error:null})}catch(n){return{data:null,error:n instanceof Error?n.message:String(n)}}}};var m=class extends u{async getStreamBuffer(e,r,x){return new Promise((f,n)=>{let a=new FileReader;a.onerror=n,a.onload=()=>f(new Uint8Array(a.result)),a.readAsArrayBuffer(e.slice(r,r+x))})}};import{readSync as H,fstatSync as Y}from"fs";var p=class extends u{constructor(e){super(e);try{if(!Y(e).isFile())throw new Error("GRFNode: file descriptor must point to a regular file")}catch{throw new Error("GRFNode: invalid file descriptor")}}async getStreamBuffer(e,r,x){let f=Buffer.allocUnsafe(x);if(H(e,f,0,x,r)!==x)throw new Error("Not a GRF file (invalid signature)");return f}};export{m as GrfBrowser,p as GrfNode};
//# sourceMappingURL=grf-loader.js.map